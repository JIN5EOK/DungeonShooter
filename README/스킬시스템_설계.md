# 개요
> Entity가 사용하는 스킬 시스템 전반에 대한 설계 문서입니다.

---

## 스킬 시스템 구조
```mermaid
classDiagram
    class EffectBase["EffectBase<br>실행할 이펙트"]{
        <<abstract>>
        #executeTarget SkillOwner // 스킬 시전자
        +Execute(SkillExecutionContext context, SkillTableEntry entry) UniTask~bool~
        +Activate(EntityBase owner, SkillTableEntry entry) void
        +Deactivate(EntityBase owner, SkillTableEntry entry) void
    }
    
    class SkillData["SkillData : ScriptableObject<br>스킬 효과 리스트와 기타 정보"]{
		+ IsPassiveSkill : bool // 패시브 이펙트 갯수 > 0
		+ IsActiveSkill : bool // 액티브 이펙트 갯수 > 0
        + PassiveEffects : List~EffectBase~ 
        // SkillComponent에 등록시 활성화 되는 이펙트
        + ActiveEffects : List~EffectBase~ 
        // 스킬을 실제로 사용시 활성화 되는 이펙트
    }

    class Skill["Skill<br>스킬을 사용할 수 있는 실제 인스턴스"]{
        +SkillData : SkillData
        +SkillTableEntry : SkillTableEntry
        +Cooldown : float
        +IsCooldown : bool
        +OnExecute : event Action
        +OnCooldownChanged : Action~float~
        +OnCooldownEnded : Action
        +Execute(EntityBase target) UniTask~bool~
        +Activate(EntityBase target) void
        +Deactivate(EntityBase target) void
    }

	class SkillTableEntry["SkillTableEntry<br>스킬 수치 테이블 엔트리<br>ITableRepository에서 제공 "]{
		+Id int // 식별 ID
		+SkillName : string
		+SkillDescription : string
		+SkillDataKey : string // SkillData에셋 주소
		+SkillIconKey : string // 스킬 아이콘 주소
		+Delay : float
		+Cooldown : float
		+TargetCount : int
        +Damage : int
        +Heal : int
		+KnockbackForce : float
        +SkillRootId : int // 스킬 레벨 구현시 베이스가 되는 SkillTableEntry ID
        +FloatAmounts : Dictionary~string, float~
        +IntAmounts : Dictionary~string, int~
	}
	
    class SkillComponent["SkillComponent : Monobehaviour<br>Entity의 고유 스킬 컨테이너 컴포넌트"]{
        -skills : Dictionary~int, Skill~
        +UseSkill(int skillEntryId) UniTask~bool~
        // ISkill.Execute 호출
        +RegistSkill(int skillEntryId) UniTask~bool~
        // SkillData를 불러와 ISkill 생성 
        +UnregistSkill(int skillEntryId) void
    }
    
	class SkillFactory["SkillFactory<br>스킬 인스턴스 생성 담당"]{
        +CreateSkillAsync(int skillEntryId) UniTask~Skill~
    }
    SkillTableEntry <-- Skill
    SkillData <-- Skill : 스킬 데이터 참조
    EffectBase "0..*"<--"1" SkillData
    SkillComponent --> Skill  : 스킬 사용, 등록, 해제
    Skill <.. SkillFactory : SkillTableEntry기반 스킬 인스턴스 생성
```
- `SkillData` : 스킬의 동작 및 효과 정보, 스크립터블 오브젝트를 통해 편집
	- `ActiveEffects` : 액티브 스킬 효과 리스트
		- 사용자가 직접 사용하여 실행
		- `Skill`의 Execute 호출시 실행
	- `PassiveEffects` : 패시브 스킬 효과 리스트
		- `SkillComponent`에 `RegistSkill`시 효과 실행
		- `SkillComponent`에 `UnregistSkill`시 효과 제거
- `SkillTableEntry` : 스킬과 스킬의 레벨별 수치 정보, CSV등 테이블을 통해 편집
  - 스킬 레벨 결정 규칙
    - `SkillRootId`를 정한다, 끝자리가 ..00으로 끝나는 ID를 사용하는걸 기본으로 한다
    - 예: 14000100 을 Root로 정했다고 가정해보자
        - 14000100 : Root ID, 사용할 수 없는 레벨 0스킬로 취급한다
        - 그 뒤로 14000101,14000102,14000103 등 1씩 더한 ID의 스킬을 만들어 각 레벨의 스킬 정보로 정의한다 
    - 런타임땐 `현재 스킬 Id - SkillRootId` 의 결과값으로 해당 스킬의 레벨이 몇인지를 구분한다
- `SkillFactory` : Id기반으로 스킬 인스턴스 생성 담당
- `SkillComponent` : 캐릭터의 고유 스킬들을 등록하고 사용
- `Skill` : 실제 스킬 인스턴스
	- 개별 스킬의 쿨다운 관리, 스킬 이펙트 실행 담당
    - `SkillComponent` 혹은 `Item`을 통해 실행

### `EffectBase`와 파생되는 스킬 이펙트 구조 예시
```mermaid
classDiagram
    class SkillExecutionContext{
        +Caster : EntityBase // 스킬 시전자
        +LastHitTarget : EntityBase // 마지막 적중 대상
        ... 그외 스킬 실행에 필요한 컨텍스트 정보 있다면 추가
    }
    
    class SkillOwner["SkillOwner<br>스킬 적용 대상자"]{
        <<Enum>>
        Caster,
        LastHitTarget
    }
    
    %% class SkillObjectBase["SkillObjectBase : Monobehaviour<br>스킬 소환 오브젝트 베이스"]{
    %%    <<abstract>>
    %%    +Initialize (EntityBase owner, List<EffectBase> effects, SkillTableEntry skillTableEntry)
    %% }
    
    class EffectBase["EffectBase<br>SkillData에서 편집 가능한 스킬 이펙트들"]{
        <<abstract>>
        #executeTarget SkillOwner // 스킬 시전자
        +Execute(SkillExecutionContext context, SkillTableEntry entry) UniTask~bool~
        +Activate(EntityBase owner, SkillTableEntry entry) void
        +Deactivate(EntityBase owner, SkillTableEntry entry) void
    }

	class HpUpPassiveEffect["HpUpPassiveEffect<br>패시브 체력 증가 이펙트 편집"]{
	}
	
    class DamageEffect["DamageEffect<br>데미지 이펙트 편집"]{
    }

    class SpawnProjectileEffect["SpawnProjectileEffect<br>투사체 소환 이펙트 편집"]{
        -_spawnPosition : SkillOwner // 투사체 생성 위치 지정
        -_skillObject : AssetReferenceT~GameObject~ // 트리거 콜라이더가 있는 아무 게임오브젝트나 가능
        -_speed : float // 비행속도
        -_lifeTime : float // 투사체 생존시간
        -_targetCount int // 타겟 수 
        -_effects : List~EffectBase~ // 스킬 적중시 효과
    }
    
    class ProjectileSkillObject["ProjectileSkillObject<br>투사체 인스턴스 프리팹"]{
    }
    
    SkillOwner <-- EffectBase
    class SkillData["SkillData : ScriptableObject<br>스킬 효과 리스트와 기타 정보"]
    EffectBase <|-- HpUpPassiveEffect
    EffectBase <|-- DamageEffect
    EffectBase <|-- SpawnProjectileEffect
    ProjectileSkillObject <-- SpawnProjectileEffect : 생성 및 이펙트 전달
    SkillData "0..*"-->"1" EffectBase : 이펙트 리스트 참조
    SkillExecutionContext <.. EffectBase
    
    %%Projectile --|> SkillObjectBase
```
- `EffectBase`는 다음 역할을 수행
	* `Execute` : 스킬 사용
	* `Activate` : 효과 활성화 (스킬 컴포넌트 등록시 실행)
	* `Deactivate` : 효과 비활성화 (스킬 컴포넌트 해제시 실행)