# 개요
> Entity가 사용하는 스킬 시스템 전반에 대한 설계 문서입니다.

---

## 스킬 시스템 구조
```mermaid
classDiagram
    class EffectBase["EffectBase<br>실행할 이펙트"]{
        <<abstract>>
        +Execute(EntityBase target, SkillTableEntry entry) UniTask~bool~
        +Activate(EntityBase target, SkillTableEntry entry) void
        +Deactivate(EntityBase target, SkillTableEntry entry) void
    }
    
    class SkillData["SkillData : ScriptableObject<br>스킬 효과 리스트와 기타 정보"]{
		+ IsPassiveSkill : bool // 패시브 이펙트 갯수 > 0
		+ IsActiveSkill : bool // 액티브 이펙트 갯수 > 0
        + PassiveEffects : List~EffectBase~ 
        // SkillComponent에 등록시 활성화 되는 이펙트
        + ActiveEffects : List~EffectBase~ 
        // 스킬을 실제로 사용시 활성화 되는 이펙트
    }

    class Skill["Skill<br>스킬을 사용하기 위한 인스턴스"]{
        +SkillData : SkillData
        +SkillTableEntry : SkillTableEntry
        +Cooldown : float
        +IsCooldown : bool
        +OnExecute : event Action
        +OnCooldownChanged : Action~float~
        +OnCooldownEnded : Action
        +Execute(EntityBase target) UniTask~bool~
        +Activate(EntityBase target) void
        +Deactivate(EntityBase target) void
    }

	class SkillTableEntry["SkillTableEntry<br>스킬 수치 테이블 엔트리"]{
		+Id int // 식별 ID
		+SkillName : string
		+SkillDescription : string
		+SkillDataKey : string // SkillData에셋 주소
		+SkillIconKey : string // 스킬 아이콘 주소
		+Delay : float
		+Cooldown : float
		+TargetCount : int
        +Damage : int
        +Heal : int
		+KnockbackForce : float
        +SkillRootId : int // 스킬 레벨 구현시 베이스가 되는 SkillTableEntry ID
        +FloatAmounts : Dictionary~string, float~
        +IntAmounts : Dictionary~string, int~
	}
	
    class SkillComponent["SkillComponent : Monobehaviour<br>Entity의 고유 스킬 컨테이너 컴포넌트"]{
        -skills : Dictionary~int, Skill~
        +UseSkill(int skillEntryId) UniTask~bool~
        // ISkill.Execute 호출
        +RegistSkill(int skillEntryId) UniTask~bool~
        // SkillData를 불러와 ISkill 생성 
        +UnregistSkill(int skillEntryId) void
    }
    
	class ITableRepository["ITableRepository<br>데이터 테이블 관리자"]{
		// 데이터 테이블 리포지토리
		// 데이터를 어떻게 가져올 것인가?의 내부 구현은 구체 클래스에서 수행
		+GetTableEntry~T~(int id) T
	}
	
	class SkillFactory["SkillFactory<br>스킬 인스턴스 생성 담당"]{
        +CreateSkillAsync(int skillEntryId) UniTask~Skill~
    }
	SkillData <-- IStageResourceRepository : 스킬 데이터 제공
    SkillTableEntry <-- Skill
    SkillData <-- Skill : 스킬 데이터 참조
    EffectBase "0..*"<--"1" SkillData
    SkillComponent --> Skill  : 스킬 사용, 등록, 해제 
    ITableRepository --> SkillTableEntry : TableEntry 데이터 제공
    Skill <.. SkillFactory : SkillTableEntry기반 스킬 인스턴스 생성
    ITableRepository <-- SkillFactory : SkillTableEntry 제공받음 
```
- `SkillData` : 스킬의 동작 및 효과 정보, 스크립터블 오브젝트를 통해 편집
	- `ActiveEffects` : 액티브 스킬 효과 리스트
		- 사용자가 직접 사용하여 실행
		- `Skill`의 Execute 호출시 실행
	- `PassiveEffects` : 패시브 스킬 효과 리스트
		- `SkillComponent`에 `RegistSkill`시 효과 실행
		- `SkillComponent`에 `UnregistSkill`시 효과 제거
- `SkillTableEntry` : 스킬과 스킬의 레벨별 수치 정보, CSV등 테이블을 통해 편집
- `SkillFactory` : Id기반으로 스킬 인스턴스 생성 담당
- `SkillComponent` : 캐릭터의 고유 스킬들을 등록하고 사용
- `Skill` : 실제 스킬 인스턴스
	- 개별 스킬의 쿨다운 관리, 스킬 이펙트 실행 담당
    - `SkillComponent` 혹은 `Item`을 통해 실행
- `ITableRepository`
	- 테이블 데이터를 불러오는 리포지토리, 세부 구현은 구체 클래스에서 담당
- `IStageResourceProvider`
	- 에셋을 불러오거나 게임오브젝트 인스턴스 생성 담당

### `EffectBase`와 파생되는 스킬 이펙트 구조 예시
```mermaid
classDiagram
    class EffectBase["EffectBase<br>실행할 이펙트"]{
        <<abstract>>
        +Execute(EntityBase target, SkillTableEntry entry) UniTask~bool~
        +Activate(EntityBase target, SkillTableEntry entry) void
        +Deactivate(EntityBase target, SkillTableEntry entry) void
    }

	class HpUpPassiveEffect["HpUpPassiveEffect<br>패시브 체력 증가"]{
		// 패시브 스킬, 활성화/비활성화 효과만 작성
	}
	
    class DamageEffect["DamageEffect<br>데미지"]{
        // 액티브 스킬, 실행 효과만 작성
    }

    class SpawnProjectileEffect["SpawnProjectileEffect<br>투사체 소환"]{
	    // 액티브 스킬, 실행 효과만 작성
        +projectile : AssetReferenceT~Projectile~ // 투사체 인스턴스 레퍼런스
        +effects : List~EffectBase~ // 투사체 적중시 효과
    }
    
    class Projectile["Projectile : Monobehaviour<br>투사체 인스턴스 프리팹"]{
        -owner : EntityBase // 소유자
        -effects : List~EffectBase~ // 투사체 적중시 효과
        -speed : float // 전진속도
        -lifeTime : float // 유지시간
        -triggerStartTime : float // 충돌 가능 시작시간
        -triggerEndTime : float // 충돌 가능 종료시간
        -destroyOnTrigger : bool // 충돌시 파괴 여부
        -applyToOppenent : bool // 상대방에게 충돌 가능 여부
        -applyToFriend : bool // 아군에게 충돌 가능 여부
    }
    class SkillData["SkillData : ScriptableObject<br>스킬 효과 리스트와 기타 정보"]
    EffectBase <|-- HpUpPassiveEffect
    EffectBase <|-- DamageEffect
    EffectBase <|-- SpawnProjectileEffect
    Projectile <-- SpawnProjectileEffect : 생성 및 이펙트 전달
    SkillData "0..*"-->"1" EffectBase : 이펙트 리스트 참조
```
- `EffectBase`는 다음 역할을 수행
	* `Execute` : 스킬 사용
	* `Activate` : 효과 활성화 (스킬 컴포넌트 등록시 실행)
	* `Deactivate` : 효과 비활성화 (스킬 컴포넌트 해제시 실행)

### 스킬 레벨 시스템
- `SkillTableEntry`에서의 ID 규칙을 통해 스킬의 레벨을 구분하고 작성한다
- 규칙은 다음과 같다
  - `SkillRootId`를 정한다, 끝자리가 ..00으로 끝나는 ID를 사용하는걸 기본으로 한다
  - 예: 14000100 을 Root로 정했다고 가정해보자
    - 14000100 : Root ID, 사용할 수 없는 레벨 0스킬로 취급한다
    - 그 뒤로 스킬 레벨이 올라갈때마다 14000101,14000102,14000103 등 끝자리에 1씩 더해가며 레벨별 스킬 데이터를 추가한다
  - 런타임땐 `현재 스킬 Id - SkillRootId` 의 결과값으로 지금 스킬 레벨이 몇인지를 구분한다