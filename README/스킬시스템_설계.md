# 개요
> Entity가 사용하는 스킬 시스템 전반에 대한 설계 문서입니다.

---

## 스킬 시스템 구조
```mermaid
classDiagram
    class EffectBase["EffectBase<br>실행할 이펙트"]{
        <<abstract>>
        +Execute(EntityBase target, SkillTableEntry entry) UniTask~bool~
        +Activate(EntityBase target, SkillTableEntry entry) void
        +Deactivate(EntityBase target, SkillTableEntry entry) void
    }
    
    class SkillData["SkillData : ScriptableObject<br>스킬 효과 리스트와 기타 정보"]{
		+ IsPassiveSkill : bool // 패시브 이펙트 갯수 > 0
		+ IsActiveSkill : bool // 액티브 이펙트 갯수 > 0
        + PassiveEffects : List~EffectBase~ // 등록시 활성화 되는 이펙트
        + ActiveEffects : List~EffectBase~ // 사용시 활성화 되는 이펙트
    }

    class Skill["Skill<br>스킬을 사용하기 위한 인스턴스"]{
        +SkillData : SkillData
        +SkillTableEntry : SkillTableEntry
        +Cooldown : float
        +IsCooldown : bool
        +OnExecute : event Action
        +OnCooldownChanged : Action~float~
        +OnCooldownEnded : Action
        +Execute(EntityBase target) UniTask~bool~
        +Activate(EntityBase target) void
        +Deactivate(EntityBase target) void
    }

	class SkillTableEntry["SkillTableEntry<br>스킬 수치 테이블 엔트리"]{
		+Id int // 식별 ID
		+SkillDataKey string // 에셋 주소
		+Amounts Dictionary~Type, AmountBase~
		+Delay float
		+Cooldown float
		+TargetCount int
		+KnockbackForce float
		+GetAmount<T>() T where T : AmountBase
	}

	class AmountBase["AmountBase<br>스킬 값 수치, 상속으로 다양한 수치 타입 제작"]{
		<<Abstract>>
	}
	
    class SkillComponent["SkillComponent : Monobehaviour<br>Entity의 스킬 컨테이너 컴포넌트"]{
        -skills : Dictionary~int, Skill~
        +UseSkill(int skillEntryId) UniTask~bool~
        // ISkill.Execute 호출
        +RegistSkill(int skillEntryId) UniTask~bool~
        // SkillData를 불러와 ISkill 생성 
        +UnregistSkill(int skillEntryId) void
    }
    
	class ITableRepository["ITableRepository<br>데이터 테이블 관리자"]{
		// 데이터 테이블 리포지토리
		// 데이터를 어떻게 가져올 것인가?의 내부 구현은 구체 클래스에서 수행
		+GetTableEntry~T~(int id) T
	}
	AmountBase "0.."*--"1" SkillTableEntry
	SkillData <-- IStageResourceRepository : 스킬 데이터 제공
    SkillTableEntry <-- Skill
    SkillData <-- Skill : 스킬 데이터 참조
    EffectBase "0..*"--"1" SkillData
    SkillComponent --> Skill  : 스킬 사용, 등록, 해제 
    ITableRepository --> SkillTableEntry : TableEntry 데이터 제공
```
- `SkillData` : 스킬의 동작 및 효과 정보, 스크립터블 오브젝트를 통해 편집
	- `ActiveEffects` : 액티브 스킬 효과 리스트
		- 사용자가 직접 사용하여 실행
		- `Skill`의 Execute 호출시 실행
	- `PassiveEffects` : 패시브 스킬 효과 리스트
		- `SkillComponent`에 `RegistSkill`시 효과 실행
		- `SkillComponent`에 `UnregistSkill`시 효과 제거
* `SkillTableEntry` : 스킬과 스킬의 레벨별 수치 정보, CSV등 테이블을 통해 편집
- `SkillComponent` : 여러 스킬 인스턴스를 등록하고 사용 담당
- `Skill` : 실제 스킬 인스턴스
	- 개별 스킬의 쿨다운 관리, 스킬 이펙트 실행 담당
- `ITableRepository`
	- 테이블 데이터를 불러오는 리포지토리, 세부 구현은 구체 클래스에서 담당
- `IStageResourceProvider`
	- 에셋을 불러오거나 게임오브젝트 인스턴스 생성 담당

### AmountBase 파생 구조와 예시
```mermaid
classDiagram
    class AmountBase["AmountBase<br>수치 베이스 클래스"]{
        <<abstract>>
        // 비제네릭 타입으로 AmountBase를 다루기 위한 계층
    }
    
    class AmountBaseT["AmountBase<T><br>제네릭 수치 클래스"]{
	    <<abstract>>
        +Amount : T
    }
    
    class DamageAmount["DamageAmount : AmountBase< int ><br>데미지 수치"]{
        +Amount : int
    }
    
    class HealAmount["HealAmount : AmountBase< int ><br>치유 수치"]{
        +Amount : int
    }
    
    AmountBase <|-- AmountBaseT
    AmountBaseT <|-- DamageAmount
    AmountBaseT <|-- HealAmount
```
### `EffectBase`와 파생되는 스킬 이펙트 구조 예시
```mermaid
classDiagram
    class EffectBase["EffectBase<br>실행할 이펙트"]{
        <<abstract>>
        +Execute(EntityBase target, SkillTableEntry entry) UniTask~bool~
        +Activate(EntityBase target, SkillTableEntry entry) void
        +Deactivate(EntityBase target, SkillTableEntry entry) void
    }

	class HpUpPassiveEffect["HpUpPassiveEffect<br>패시브 체력 증가"]{
		// 패시브 스킬, 활성화/비활성화 효과만 작성
	}
	
    class DamageEffect["DamageEffect<br>데미지"]{
        // 액티브 스킬, 실행 효과만 작성
    }


    class SpawnProjectileEffect["SpawnProjectileEffect<br>투사체 소환"]{
	    // 액티브 스킬, 실행 효과만 작성
        +projectile : AssetReferenceT~Projectile~ // 투사체 인스턴스 레퍼런스
        +effects : List~EffectBase~ // 투사체 적중시 효과
    }
    
    class Projectile["Projectile : Monobehaviour<br>투사체 인스턴스 프리팹"]{
        -owner : EntityBase // 소유자
        -effects : List~EffectBase~ // 투사체 적중시 효과
        -speed : float // 전진속도
        -lifeTime : float // 유지시간
        -triggerStartTime : float // 충돌 가능 시작시간
        -triggerEndTime : float // 충돌 가능 종료시간
        -destroyOnTrigger : bool // 충돌시 파괴 여부
        -applyToOppenent : bool // 상대방에게 충돌 가능 여부
        -applyToFriend : bool // 아군에게 충돌 가능 여부
    }

    EffectBase <|-- HpUpPassiveEffect
    EffectBase <|-- DamageEffect
    EffectBase <|-- SpawnProjectileEffect
    Projectile <-- SpawnProjectileEffect : 생성 및 이펙트 전달
```
- `EffectBase`는 다음 역할을 수행
	* `Execute` : 스킬 사용
	* `Activate` : 효과 활성화 (스킬 컴포넌트 등록시 실행)
	* `Deactivate` : 효과 비활성화 (스킬 컴포넌트 해제시 실행)


### Entity에 스킬 등록 플로우
```mermaid
sequenceDiagram
    SkillComponent->>ITableRepository: Id기반으로 SkillEntryData 요청
    ITableRepository-->>SkillComponent: SkillTableEntry 제공
    SkillComponent->>IStageResourceProvider: SkillData 요청
    IStageResourceProvider-->>SkillComponent: SkillData 제공
    SkillComponent->>Skill: new Skill(SkillData, SkillTableEntry)
```
* SkillData(스킬 동작 데이터), SkillTableEntry(스킬 수치 데이터)를 조합하여 Skill 인스턴스 생성, 스킬 컴포넌트에 등록