# 개요
> Entity의 스탯 시스템에 대한 설계 문서입니다.
- 특징
  - 스탯 테이블의 기본 스탯을 기반으로 아이템, 스킬등의 보너스 값에 따라 스탯 계산 연산을 적용
## Entity 스탯 시스템 구조

### 스탯 시스템 구조도
```mermaid
classDiagram
    class StatType["StatType<br>스탯 타입 Enum"]{
        Hp,
        Attack,
        Defense,
        MoveSpeed
    }
    class StatModifierType["StatModifierType<br>스탯 변경 데이터 타입"]{
        Constant // StatTable의 기본수치
        Add // 더하기
        Multiply // 곱하기
    }
    
    class EntityStat["EntityStat<br>개별 스탯, 장비와 아이템에 의한 최종 스탯 계산"]{
        +GetValue() int // 최종 수치
        +GetOriginValue() int // 원본 수치 (Constant 값만)
        +AddModifier(object key, StatModifierType modiType, int value) void
        // Modifier key는 스탯 요청 발원지 오브젝트 사용
        +RemoveModifier(object key) void
    }

    class EntityStatContainer["EntityStatContainer<br>Entity의 스탯 컨테이너"]{
        +Stats : Dictionary~StatType, EntityStat~
        -StatsTableEntry : EntityStatsTableEntry
        // EntityStatsTableEntry의 수치는 AddModifier->Constant 타입으로 반영
        +ApplyStatBonus(object key, StatBonus statBonus) void// 스탯 보너스 적용
        +RemoveStatBonus(object key) void// 스탯 보너스 제거
        +GetStat(StatType type) int // 최종 스탯 수치
        +GetStatOrigin(StatType type) int // 캐릭터 고유 스탯 수치
    }
    
    class StatBonus["StatBonus<br>아이템등의 스탯 보너스 수치"]{
        +HpAdd : int // 체력증가 수치
        +HpMultiply : int // 체력증가 곱비율
        ... // 그외 스탯 보너스 정보
    }
    
    class EntityStatsTableEntry["EntityStatsTableEntry<br>스탯 테이블 데이터"]{
        +Id : int
        +MaxHp : int
        +Attack : int
        +Defense : int
        +MoveSpeed : int
    }

    class PlayerConfigTableEntry["PlayerConfigTableEntry<br>플레이어 테이블 데이터"]{
        +Id int
        +Name string
        +Description string
        +GameObjectKey string // 게임오브젝트 주소
        +StartWeaponId int // 시작 무기 TableEntry Id
        +Skill1Id int // 1번 스킬 TableEntry Id
        +Skill2Id int // 2번 스킬 TableEntry Id
        +StatsId int // 스텟 EntityStatsTableEntry.Id
    }
    
    class EnemyConfigTableEntry["EnemyConfigTableEntry<br>적 테이블 데이터"]{
        +Id int
        +Name string
        +GameObjectKey string // 적 프리팹 주소
        +AIType string // 행동 타입
        +StatsId int // 스텟 EntityStatsTableEntry.Id
    }
    class EntityBase["EntityBase : Monobehaviour<br>Entity Base 컴포넌트"]{
        +StatContainer EntityStatContainer
    }
    EntityStatContainer ..> StatBonus : 아이템등의 스탯 보너스 수치
    StatModifierType "0..*"<--"1" EntityStat
    StatType "0..*"<--"1" EntityStatContainer
    EntityStat "0..*"<--"1" EntityStatContainer
    EntityStatContainer --> EntityStatsTableEntry  : 테이블 데이터에 기반하여 기본 스탯 설정
    EntityStatsTableEntry <.. PlayerConfigTableEntry : Table ID로 간접 참조
    EntityStatsTableEntry <.. EnemyConfigTableEntry : Table ID로 간접 참조
    EntityStatContainer <-- EntityBase : 본인의 스탯 참조
```


- 주요 클래스와 역할
    - `EntityStatsTableEntry` : 데이터 테이블로 작성하는 개체별 '기본 스탯'
    - `EntityStat` : HP, 이동속도 등의 개별 스탯, 추가된 스탯 보너스를 계산하여 최종 스탯 계산
    - `EntityStatContainer` : 개별 스탯들이 모인 컨테이너
- Entity 스탯 초기화
    1. `PlayerConfigTableEntry`, `EnemyConfigTableEntry`에서 스탯 ID를 가져온다
    2. `ITableRepository`에서 ID로 조회해 `EntityStatsTableEntry`를 가져온다
    3. 게임오브젝트에 `StatsComponent`를 AddComponent 하고 가져온 `EntityStatsTableEntry`을 삽입, `StatType.Constant` 타입으로 StatModifier을 추가
- Entity 스탯 반영 방법
    - 합산 구조로 최종 스탯값을 결정한다
    - 기본 스탯 정보, 아이템, 스킬 등에 의해 각 `EntityStat`들에 StatModifer들이 추가된다
    - 스탯 보너스 구조
      - `Constant` -> `EntityStatsTableEntry`에 의해 적용되는 기본 수치 
      - `Add`,`Multiply` -> 아이템등의 `StatBonus`에 의해 적용되는 더하기, 곱셈 보정
          - 100% 단위를 기준으로 한다, 예: 50% -> 0.5배, 200% -> 2배
      - `Constant` -> `Add` -> `Multiply` 순으로 스탯에 반영하여 최종 스탯을 계산해낸다
      - 최종 값들은 한번 연산한후 캐싱해두고 사용, Add,Remove등으로 값 변동이 일어나게 되면 다시 계산한다
        - 더티 플래그 패턴 사용